--Exercicio 1:

CREATE OR REPLACE TRIGGER TRG_MENORES
BEFORE INSERT OR UPDATE ON AMIGO
FOR EACH ROW
BEGIN

IF(:NEW.IDADE <18 )THEN
RAISE_APPLICATION_ERROR(-20001,'ERRO: ' || :NEW.ANOME || ' Tem menos de 18 anos');
END IF;
END;

--Exercicio 2:

CREATE OR REPLACE TRIGGER TRG_LIMITE_LISTA_V1
BEFORE INSERT ON LISTAPRESENTE
FOR EACH ROW
DECLARE
    V_VALOR_NOVO NUMBER;
    V_QTD_ATUAL NUMBER;
    V_SOMA_ATUAL NUMBER;
BEGIN
    SELECT PVALOR INTO V_VALOR_NOVO 
    FROM PRESENTE 
    WHERE PID = :NEW.PID;

    SELECT COUNT(*), NVL(SUM(P.PVALOR), 0)
    INTO V_QTD_ATUAL, V_SOMA_ATUAL
    FROM LISTAPRESENTE L
    JOIN PRESENTE P ON L.PID = P.PID
    WHERE L.AID = :NEW.AID;

    IF V_QTD_ATUAL >= 10 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Limite de 10 itens excedido.');
    END IF;

    IF (V_SOMA_ATUAL + V_VALOR_NOVO) > 500 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Valor total excederia R$ 500,00.');
    END IF;
END;

--Exercicio 3:

--Criar View:

CREATE OR REPLACE VIEW V_LISTAPRESENTE AS
SELECT AID, PID, PREFERENCIA
FROM LISTAPRESENTE;

--Trigger:


CREATE OR REPLACE TRIGGER TRG_QTDE_MAX_PRES
INSTEAD OF INSERT OR DELETE ON V_LISTAPRESENTE
FOR EACH ROW 
DECLARE      
    V_QTD_ATUAL NUMBER;
BEGIN
    IF INSERTING THEN
        SELECT COUNT(*) INTO V_QTD_ATUAL
        FROM LISTAPRESENTE
        WHERE AID = :NEW.AID;

        IF V_QTD_ATUAL >= 10 THEN
            RAISE_APPLICATION_ERROR(-20007, 'ERRO: MÁXIMO DE 10 PRESENTES PERMITIDO.');
        END IF;

        INSERT INTO LISTAPRESENTE (AID, PID, PREFERENCIA)
        VALUES (:NEW.AID, :NEW.PID, :NEW.PREFERENCIA);
    END IF;

    IF DELETING THEN 
        SELECT COUNT(*) INTO V_QTD_ATUAL
        FROM LISTAPRESENTE
        WHERE AID = :OLD.AID;

        IF V_QTD_ATUAL <= 1 THEN
             RAISE_APPLICATION_ERROR(-20009, 'ERRO: A LISTA DEVE TER NO MINIMO 1 PRESENTE.');
        END IF;

        DELETE FROM LISTAPRESENTE
        WHERE AID = :OLD.AID AND PID = :OLD.PID;
    END IF;
END;

--Exercicio 4:

CREATE OR REPLACE TRIGGER TRG_VALIDA_PRESENTE_LISTA
BEFORE INSERT OR UPDATE ON AMIGOSECRETO
FOR EACH ROW
DECLARE
    v_existe NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_existe
    FROM LISTAPRESENTE
    WHERE AID = :NEW.AID_AMIGO
      AND PID = :NEW.PID_RECEBIDO;

    IF v_existe = 0 THEN
        RAISE_APPLICATION_ERROR(-20006, 'ERRO: Este presente não está na lista de desejos do amigo sorteado.');
    END IF;
END;

Exercicio 5:

--Alter Table:

ALTER TABLE MATRICULA ADD MEDIA NUMBER(4,2);

--Trigger:

CREATE OR REPLACE TRIGGER TRG_ATUALIZA_MEDIA
AFTER INSERT OR UPDATE OR DELETE ON ALUNO_AVALIACAO
FOR EACH ROW
DECLARE
    v_id_disciplina NUMBER;
    v_id_aluno      NUMBER;
    v_id_avaliacao  NUMBER;
    v_media         NUMBER;
BEGIN
    IF DELETING THEN
        v_id_aluno := :OLD.ID_ALUNO;
        v_id_avaliacao := :OLD.ID_AVALIACAO;
    ELSE
        v_id_aluno := :NEW.ID_ALUNO;
        v_id_avaliacao := :NEW.ID_AVALIACAO;
    END IF;

    SELECT ID_DISCIPLINA 
    INTO v_id_disciplina
    FROM AVALIACAO 
    WHERE ID_AVALIACAO = v_id_avaliacao;

    SELECT AVG(AA.NOTA)
    INTO v_media
    FROM ALUNO_AVALIACAO AA
    JOIN AVALIACAO A ON AA.ID_AVALIACAO = A.ID_AVALIACAO
    WHERE AA.ID_ALUNO = v_id_aluno
      AND A.ID_DISCIPLINA = v_id_disciplina;

    UPDATE MATRICULA
    SET MEDIA = ROUND(v_media, 2) 
    WHERE ID_ALUNO = v_id_aluno
      AND ID_DISCIPLINA = v_id_disciplina;
      
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        NULL; 
END;


--Exercicio 6:

--Alterar a tabela:

ALTER TABLE MATRICULA ADD(
    SITUACAO VARCHAR2(15)
);

--Trigger:

CREATE OR REPLACE TRIGGER TGR_SITUACAO_ALUNO
BEFORE INSERT OR UPDATE OF MEDIA ON MATRICULA
FOR EACH ROW
BEGIN
    IF :NEW.MEDIA >= 6.0 THEN
        :NEW.SITUACAO := 'APROVADO';
    ELSIF :NEW.MEDIA >= 4.0 THEN
        :NEW.SITUACAO := 'RECUPERAÇÃO';
    ELSE
        :NEW.SITUACAO := 'REPROVADO';
    END IF;
END;
